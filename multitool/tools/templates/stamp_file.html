<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Draggable Stamp Tool</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
  <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
  <style>
    #preview-container {
      position: relative;
      display: inline-block;
      border: 2px dashed #ccc;
    }

    #baseImage {
      width: 600px;
      display: block;
    }

    #stampImage {
      position: absolute;
      top: 20px;
      left: 20px;
      width: 100px;
      cursor: move;
      z-index: 10;
    }
  </style>
</head>
<body class="bg-light">
<div class="container py-5">
  <div class="card shadow p-4">
    <h3 class="text-center mb-4">ðŸ–¼ Stamp & Drag Anywhere</h3>

    <form method="POST" enctype="multipart/form-data">
      {% csrf_token %}
      <div class="mb-3">
        <label class="form-label">Upload Base Image</label>
        <input type="file" class="form-control" name="base_file" accept="image/*" required>
      </div>

      <div class="mb-3">
        <label class="form-label">Upload Stamp (PNG)</label>
        <input type="file" class="form-control" name="stamp_file" accept="image/png" required>
      </div>

      <input type="hidden" name="stamp_x" id="stamp_x">
      <input type="hidden" name="stamp_y" id="stamp_y">
      <input type="hidden" name="base_actual_width" id="base_actual_width">

      <button class="btn btn-primary w-100" type="submit">Apply Stamp</button>
    </form>

    {% if base_image_data and stamp_image_data %}
    <div class="mt-4 text-center">
      <h5 class="text-success">Drag the stamp where you want!</h5>
      <div id="preview-container">
        <img id="baseImage" src="data:image/png;base64,{{ base_image_data }}">
        <img id="stampImage" src="data:image/png;base64,{{ stamp_image_data }}">
      </div>

      <div class="text-center mt-4">
        <button class="btn btn-success" id="downloadBtn">ðŸ“¥ Download</button>
      </div>
    </div>
    {% endif %}
  </div>
</div>

<script>
  const stamp = document.getElementById("stampImage");
  const stampX = document.getElementById("stamp_x");
  const stampY = document.getElementById("stamp_y");
  const baseImage = document.getElementById("baseImage");

  window.onload = () => {
    if (baseImage) {
      document.getElementById("base_actual_width").value = baseImage.naturalWidth;
    }
  };

  if (stamp) {
    let isDragging = false;

    stamp.addEventListener("mousedown", function(e) {
      isDragging = true;
      let offsetX = e.offsetX;
      let offsetY = e.offsetY;

      document.onmousemove = function(ev) {
        if (!isDragging) return;
        const container = document.getElementById("preview-container");
        const rect = container.getBoundingClientRect();

        let x = ev.clientX - rect.left - offsetX;
        let y = ev.clientY - rect.top - offsetY;

        x = Math.max(0, Math.min(container.offsetWidth - stamp.offsetWidth, x));
        y = Math.max(0, Math.min(container.offsetHeight - stamp.offsetHeight, y));

        stamp.style.left = x + "px";
        stamp.style.top = y + "px";
      };

      document.onmouseup = function() {
        isDragging = false;
        stampX.value = parseInt(stamp.style.left);
        stampY.value = parseInt(stamp.style.top);

        document.onmousemove = null;
        document.onmouseup = null;
      };
    });
  }

  // ðŸŸ¢ Download visible preview as image
  document.getElementById("downloadBtn")?.addEventListener("click", function () {
    const previewBox = document.getElementById("preview-container");
    html2canvas(previewBox).then(canvas => {
      const link = document.createElement("a");
      link.download = "stamped_preview.png";
      link.href = canvas.toDataURL();
      link.click();
    });
  });
</script>
</body>
</html>
